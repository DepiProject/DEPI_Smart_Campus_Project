<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deleted Instructors - Smart Campus Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm"
        style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-mortarboard-fill"></i> Smart Campus Admin
            </a>
            <div class="navbar-nav ms-auto d-flex gap-2">
                <a class="nav-link btn btn-light btn-sm text-primary fw-semibold" href="admin-dashboard.html"
                    style="border-radius: 8px; padding: 8px 16px;">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                <a class="nav-link btn btn-danger btn-sm fw-semibold" href="#" id="logoutBtn"
                    style="border-radius: 8px; padding: 8px 16px;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="admin-dashboard.html">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-archive"></i> Deleted Instructors
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-archive"></i> Archived Instructors
                    </h1>
                </div>

                <!-- Archived Instructors Table -->
                <div class="card shadow-sm border-0" style="border-radius: 16px; overflow: hidden;">
                    <div class="card-header text-white"
                        style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 20px 24px;">
                        <h5 class="mb-2 fw-bold">
                            <i class="bi bi-archive-fill"></i> Archived Instructors
                        </h5>
                        <small style="opacity: 0.95;">These instructors have been archived. All teaching records are
                            preserved.</small>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <div class="table-responsive" style="border-radius: 12px; overflow: hidden;">
                            <table class="table table-hover mb-0">
                                <thead style="background: linear-gradient(135deg, #f8fafc, #e2e8f0);">
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Department</th>
                                        <th>Contact</th>
                                        <th>Deleted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedInstructorsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> <strong>About Archived Instructors:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>Restore:</strong> Reactivates the instructor account and makes them available again
                        </li>
                        <li><strong>Preservation:</strong> All teaching records, course history, and exam data are
                            preserved</li>
                        <li>Archived instructors cannot log in or teach courses</li>
                        <li>Archived instructors do not appear in active instructor listings</li>
                        <li><strong>Note:</strong> Instructors with teaching records CANNOT be permanently deleted
                            (audit trail preservation)</li>
                    </ul>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Permanent Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">Are you sure you want to permanently delete this instructor?</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Forever</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            // Check authentication
            const token = localStorage.getItem('authToken');
            if (!token || API.isTokenExpired()) {
                window.location.href = '../index.html';
                return;
            }

            // Check if user is admin
            const role = API.getUserRole();
            if (role !== 'Admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '../index.html';
                return;
            }

            // Create a minimal dashboard instance
            const dashboard = {
                showToast: function (title, message, type) {
                    const toastContainer = document.getElementById('toastContainer');
                    const toastId = 'toast-' + Date.now();
                    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-warning';

                    const toastHtml = `
                        <div class="toast align-items-center text-white ${bgClass} border-0" id="${toastId}" role="alert">
                            <div class="d-flex">
                                <div class="toast-body">
                                    <strong>${title}:</strong> ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    `;
                    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                    const toastEl = document.getElementById(toastId);
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                },

                loadDeletedInstructors: async function () {
                    console.log('üë®‚Äçüè´ Loading archived instructors...');
                    const response = await API.instructor.getAllIncludingDeleted();
                    const tbody = document.getElementById('deletedInstructorsTableBody');

                    if (response.success && response.data) {
                        let instructors = Array.isArray(response.data.data) ? response.data.data :
                            Array.isArray(response.data) ? response.data : [];

                        const deletedInstructors = instructors.filter(i => i.deletedAt);

                        if (deletedInstructors.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No archived instructors found</td></tr>';
                            return;
                        }

                        tbody.innerHTML = deletedInstructors.map(instructor => `
                            <tr style="background-color: #fef3c7;">
                                <td>
                                    <strong style="color: #1e293b;">${instructor.fullName || 'N/A'}</strong>
                                    <span class="badge ms-2" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); padding: 6px 12px; border-radius: 8px;">Archived</span>
                                </td>
                                <td><small>${instructor.email || '-'}</small></td>
                                <td><small>${instructor.departmentName || '-'}</small></td>
                                <td>${instructor.contactNumber || '-'}</td>
                                <td><small>${instructor.deletedAt ? new Date(instructor.deletedAt).toLocaleDateString() : '-'}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="restoreInstructor(${instructor.instructorId})" title="Restore">
                                        <i class="bi bi-arrow-counterclockwise"></i> Restore
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmPermanentDelete(${instructor.instructorId})" title="Permanent Delete">
                                        <i class="bi bi-trash-fill"></i> Delete Forever
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load archived instructors</td></tr>';
                    }
                }
            };

            // Global function for restore button
            window.restoreInstructor = async function (id) {
                try {
                    const response = await API.instructor.restore(id);
                    if (response.success) {
                        dashboard.showToast('Success', 'Instructor restored successfully!', 'success');
                        dashboard.loadDeletedInstructors();
                    } else {
                        dashboard.showToast('Error', 'Failed to restore instructor', 'error');
                    }
                } catch (error) {
                    dashboard.showToast('Error', 'Failed to restore instructor', 'error');
                }
            };

            // Global function for permanent delete
            window.confirmPermanentDelete = async function (id) {
                try {
                    const checkResponse = await API.instructor.canPermanentlyDelete(id);
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    const deleteMessage = document.getElementById('deleteMessage');
                    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

                    window.deleteConfirmId = id;

                    if (checkResponse && checkResponse.success && checkResponse.data) {
                        const canDelete = checkResponse.data.canDelete || checkResponse.data.CanDelete;
                        const reason = checkResponse.data.reason || checkResponse.data.Reason || 'Unknown reason';

                        if (canDelete) {
                            deleteMessage.innerHTML = `
                                <div class="text-warning mb-3">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                    <h5>‚ö†Ô∏è PERMANENT DELETE WARNING</h5>
                                </div>
                                <p>This instructor has no course history or teaching records.</p>
                                <p class="text-danger"><strong>This action will permanently remove this instructor from the database and CANNOT be undone!</strong></p>
                                <p>Are you sure you want to proceed?</p>
                            `;
                            confirmDeleteBtn.style.display = 'inline-block';
                        } else {
                            deleteMessage.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-ban fa-2x mb-3"></i>
                                    <h5>‚ùå Cannot Permanently Delete</h5>
                                </div>
                                <p><strong>Reason:</strong> ${reason}</p>
                                <p>This instructor must remain in the system to preserve:</p>
                                <ul class="text-start">
                                    <li>Course teaching records</li>
                                    <li>Exam creation history</li>
                                    <li>Academic audit trail</li>
                                </ul>
                                <p class="text-info mt-3"><i class="fas fa-info-circle"></i> You can restore this instructor to make them active again.</p>
                            `;
                            confirmDeleteBtn.style.display = 'none';
                        }
                    } else {
                        deleteMessage.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>Error</h5>
                            </div>
                            <p>Unable to verify instructor data. Permanent deletion is not available for safety.</p>
                        `;
                        confirmDeleteBtn.style.display = 'none';
                    }

                    deleteModal.show();
                } catch (error) {
                    console.error('Error checking instructor deletion eligibility:', error);
                }
            };

            // Load archived instructors
            await dashboard.loadDeletedInstructors();

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function (e) {
                e.preventDefault();
                API.logout();
                window.location.href = '../index.html';
            });

            // Confirm delete button
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
                const id = window.deleteConfirmId;
                if (!id) return;

                try {
                    const response = await API.instructor.permanentDelete(id);
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide();

                    if (response.success) {
                        dashboard.showToast('Success', 'Instructor permanently deleted!', 'success');
                        dashboard.loadDeletedInstructors();
                    } else {
                        dashboard.showToast('Error', 'Failed to delete instructor', 'error');
                    }
                } catch (error) {
                    dashboard.showToast('Error', 'Failed to delete instructor', 'error');
                }
            });
        });
    </script>
</body>

</html>