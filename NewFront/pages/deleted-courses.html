<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deleted Courses - Smart Campus Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm"
        style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-mortarboard-fill"></i> Smart Campus Admin
            </a>
            <div class="navbar-nav ms-auto d-flex gap-2">
                <a class="nav-link btn btn-light btn-sm text-primary fw-semibold" href="admin-dashboard.html"
                    style="border-radius: 8px; padding: 8px 16px;">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                <a class="nav-link btn btn-danger btn-sm fw-semibold" href="#" id="logoutBtn"
                    style="border-radius: 8px; padding: 8px 16px;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="admin-dashboard.html">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-archive"></i> Archived Courses
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-archive"></i> Archived Courses
                    </h1>
                </div>

                <!-- Archived Courses Table -->
                <div class="card shadow-sm border-0" style="border-radius: 16px; overflow: hidden;">
                    <div class="card-header text-white"
                        style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 20px 24px;">
                        <h5 class="mb-2 fw-bold">
                            <i class="bi bi-archive-fill"></i> Archived Courses
                        </h5>
                        <small style="opacity: 0.95;">These courses can be restored or permanently deleted</small>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <div class="table-responsive" style="border-radius: 12px; overflow: hidden;">
                            <table class="table table-hover mb-0">
                                <thead style="background: linear-gradient(135deg, #f8fafc, #e2e8f0);">
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Instructor</th>
                                        <th>Credits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedCoursesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> <strong>About Deleted Courses:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>Restore:</strong> Makes the course active again and available for enrollment</li>
                        <li><strong>Delete Forever:</strong> Permanently removes the course from the database (cannot be
                            undone)</li>
                        <li>Soft-deleted courses do not appear in active course listings</li>
                        <li>Course codes from deleted courses remain reserved until permanently deleted</li>
                    </ul>
                </div>
            </main>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Permanent Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">Are you sure you want to permanently delete this course?</p>
                    <p class="text-danger"><strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone!</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Forever</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/admin-dashboard.js"></script>
    <script>
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            // Check authentication
            const token = localStorage.getItem('authToken');
            if (!token || API.isTokenExpired()) {
                window.location.href = '../index.html';
                return;
            }

            // Check if user is admin
            const role = API.getUserRole();
            if (role !== 'Admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '../index.html';
                return;
            }

            // Create a minimal AdminDashboard instance
            const dashboard = {
                showToast: function (title, message, type) {
                    const toastContainer = document.getElementById('toastContainer');
                    const toastId = 'toast-' + Date.now();
                    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-warning';

                    const toastHtml = `
                        <div class="toast align-items-center text-white ${bgClass} border-0" id="${toastId}" role="alert">
                            <div class="d-flex">
                                <div class="toast-body">
                                    <strong>${title}:</strong> ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    `;
                    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                    const toastEl = document.getElementById(toastId);
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                },

                loadDeletedCourses: async function () {
                    console.log('üìñ Loading deleted courses...');
                    // Add cache-busting and force refresh
                    const timestamp = new Date().getTime();
                    const random = Math.random();
                    const response = await fetch(`https://smartcampus-university.runasp.net/api/Course/all-including-deleted?_t=${timestamp}&_r=${random}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    }).then(r => r.json()).then(data => ({ success: true, data: data.Data || data.data || data })).catch(err => ({ success: false, error: err.message }));
                    const tbody = document.getElementById('deletedCoursesTableBody');

                    if (response.success && response.data) {
                        let courses = Array.isArray(response.data.data) ? response.data.data :
                            Array.isArray(response.data) ? response.data : [];

                        const deletedCourses = courses.filter(c => c.deletedAt);

                        if (deletedCourses.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No deleted courses found</td></tr>';
                            return;
                        }

                        tbody.innerHTML = deletedCourses.map(course => `
                            <tr class="table-secondary">
                                <td>
                                    <strong>${course.courseCode || '-'}</strong>
                                    <span class="badge bg-danger ms-2">Deleted</span>
                                </td>
                                <td>${course.name}</td>
                                <td><small>${course.departmentName || '-'}</small></td>
                                <td><small>${course.instructorName || '-'}</small></td>
                                <td>${course.creditHours || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="restoreCourse(${course.id})" title="Restore">
                                        <i class="bi bi-arrow-counterclockwise"></i> Restore
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmPermanentDelete(${course.id})" title="Permanent Delete">
                                        <i class="bi bi-trash-fill"></i> Delete Forever
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load deleted courses</td></tr>';
                    }
                }
            };

            // Global functions for button clicks
            window.restoreCourse = async function (id) {
                try {
                    const response = await API.course.restore(id);
                    if (response.success) {
                        dashboard.showToast('Success', 'Course restored successfully!', 'success');
                        dashboard.loadDeletedCourses();
                    } else {
                        dashboard.showToast('Error', 'Failed to restore course', 'error');
                    }
                } catch (error) {
                    dashboard.showToast('Error', 'Failed to restore course', 'error');
                }
            };

            window.confirmPermanentDelete = async function (id) {
                try {
                    // Check if course can be permanently deleted
                    console.log('üîç Checking if course can be deleted, ID:', id);
                    const checkResponse = await API.course.canPermanentlyDelete(id);
                    console.log('üìä Full canDelete response:', checkResponse);
                    console.log('üìä Response.data:', checkResponse.data);

                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    const deleteMessage = document.getElementById('deleteMessage');
                    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

                    window.deleteConfirmId = id;

                    if (checkResponse && checkResponse.success && checkResponse.data) {
                        const canDelete = checkResponse.data.canDelete || checkResponse.data.CanDelete;
                        const reason = checkResponse.data.reason || checkResponse.data.Reason || 'Unknown reason';

                        console.log('‚úÖ Can delete?', canDelete);
                        console.log('üìù Reason:', reason);

                        if (canDelete) {
                            // Can be permanently deleted
                            deleteMessage.innerHTML = `
                                <div class="text-warning mb-3">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                    <h5>‚ö†Ô∏è PERMANENT DELETE WARNING</h5>
                                </div>
                                <p>This course has no enrollment history or exam records.</p>
                                <p class="text-danger"><strong>This action will permanently remove this course from the database and CANNOT be undone!</strong></p>
                                <p>Are you sure you want to proceed?</p>
                            `;
                            confirmDeleteBtn.style.display = 'inline-block';
                        } else {
                            // Cannot be permanently deleted
                            deleteMessage.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-ban fa-2x mb-3"></i>
                                    <h5>‚ùå Cannot Permanently Delete</h5>
                                </div>
                                <p><strong>Reason:</strong> ${reason}</p>
                                <p>This course must remain in the system to preserve:</p>
                                <ul class="text-start">
                                    <li>Student enrollment records and grades</li>
                                    <li>Exam history and submissions</li>
                                    <li>Attendance records</li>
                                    <li>Academic audit trail</li>
                                </ul>
                                <p class="text-info mt-3"><i class="fas fa-info-circle"></i> You can restore this course to make it active again.</p>
                            `;
                            confirmDeleteBtn.style.display = 'none';
                        }
                    } else {
                        // Error checking
                        deleteMessage.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                                <h5>Error</h5>
                            </div>
                            <p>Unable to verify course data. Permanent deletion is not available for safety.</p>
                            <p class="text-info"><i class="fas fa-info-circle"></i> You can restore this course to make it active again.</p>
                        `;
                        confirmDeleteBtn.style.display = 'none';
                    }

                    deleteModal.show();
                } catch (error) {
                    console.error('Error checking course deletion eligibility:', error);
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    const deleteMessage = document.getElementById('deleteMessage');
                    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

                    window.deleteConfirmId = id;
                    deleteMessage.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                            <h5>Error</h5>
                        </div>
                        <p>Error checking course data. Permanent deletion is not available for safety.</p>
                    `;
                    confirmDeleteBtn.style.display = 'none';
                    deleteModal.show();
                }
            };

            // Load deleted courses
            await dashboard.loadDeletedCourses();

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function (e) {
                e.preventDefault();
                API.logout();
                window.location.href = '../index.html';
            });

            // Confirm delete button
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
                const id = window.deleteConfirmId;
                if (!id) return;

                try {
                    console.log('üî• Permanently deleting course ID:', id);
                    const response = await API.course.permanentDelete(id);
                    console.log('üìä Delete response:', response);

                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide();

                    if (response.success) {
                        dashboard.showToast('Success', 'Course permanently deleted!', 'success');

                        // Wait 2 seconds for database to commit before reloading
                        console.log('‚è≥ Waiting for database commit...');
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        console.log('üîÑ Reloading deleted courses list...');
                        await dashboard.loadDeletedCourses();
                        console.log('‚úÖ Course should now be gone from the list');
                    } else {
                        dashboard.showToast('Error', 'Failed to delete course', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Delete error:', error);
                    dashboard.showToast('Error', 'Failed to delete course', 'error');
                }
            });
        });
    </script>
</body>

</html>