<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deleted Departments - Smart Campus Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm"
        style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-mortarboard-fill"></i> Smart Campus Admin
            </a>
            <div class="navbar-nav ms-auto d-flex gap-2">
                <a class="nav-link btn btn-light btn-sm text-primary fw-semibold" href="admin-dashboard.html"
                    style="border-radius: 8px; padding: 8px 16px;">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                <a class="nav-link btn btn-danger btn-sm fw-semibold" href="#" id="logoutBtn"
                    style="border-radius: 8px; padding: 8px 16px;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="admin-dashboard.html">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-archive"></i> Archived Departments
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-archive"></i> Archived Departments
                    </h1>
                </div>

                <!-- Archived Departments Table -->
                <div class="card shadow-sm border-0" style="border-radius: 16px; overflow: hidden;">
                    <div class="card-header text-white"
                        style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 20px 24px;">
                        <h5 class="mb-2 fw-bold">
                            <i class="bi bi-archive-fill"></i> Archived Departments
                        </h5>
                        <small style="opacity: 0.95;">These departments have been archived. All academic records are
                            preserved.</small>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <div class="table-responsive" style="border-radius: 12px; overflow: hidden;">
                            <table class="table table-hover mb-0">
                                <thead style="background: linear-gradient(135deg, #f8fafc, #e2e8f0);">
                                    <tr>
                                        <th>Name</th>
                                        <th>Building</th>
                                        <th>Head</th>
                                        <th>Deleted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedDepartmentsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> <strong>About Archived Departments:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>Restore:</strong> Reactivates the department and makes it available again</li>
                        <li><strong>Preservation:</strong> All student enrollments, instructor assignments, and course
                            records are preserved</li>
                        <li>Archived departments do not appear in active department listings</li>
                        <li>Students and instructors cannot be assigned to archived departments</li>
                        <li><strong>Note:</strong> Departments with students, instructors, or courses CANNOT be
                            permanently deleted (data integrity)</li>
                    </ul>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Permanent Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">Are you sure you want to permanently delete this department?</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Forever</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('authToken');
            if (!token || API.isTokenExpired()) {
                window.location.href = '../index.html';
                return;
            }

            const role = API.getUserRole();
            if (role !== 'Admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '../index.html';
                return;
            }

            const dashboard = {
                showToast: function (title, message, type) {
                    const toastContainer = document.getElementById('toastContainer');
                    const toastId = 'toast-' + Date.now();
                    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-warning';

                    const toastHtml = `
                        <div class="toast align-items-center text-white ${bgClass} border-0" id="${toastId}" role="alert">
                            <div class="d-flex">
                                <div class="toast-body">
                                    <strong>${title}:</strong> ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    `;
                    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                    const toastEl = document.getElementById(toastId);
                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                },

                loadDeletedDepartments: async function () {
                    console.log('üè¢ Loading archived departments...');
                    const response = await API.department.getAllIncludingDeleted();
                    const tbody = document.getElementById('deletedDepartmentsTableBody');

                    if (response.success && response.data) {
                        let departments = Array.isArray(response.data.data) ? response.data.data :
                            Array.isArray(response.data) ? response.data : [];

                        const deletedDepartments = departments.filter(d => d.deletedAt);

                        if (deletedDepartments.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No archived departments found</td></tr>';
                            return;
                        }

                        tbody.innerHTML = deletedDepartments.map(dept => `
                            <tr class="table-secondary">
                                <td>
                                    <strong>${dept.name || 'N/A'}</strong>
                                    <span class="badge bg-danger ms-2">Archived</span>
                                </td>
                                <td>${dept.building || '-'}</td>
                                <td><small>${dept.headFullName || 'No Head'}</small></td>
                                <td><small>${dept.deletedAt ? new Date(dept.deletedAt).toLocaleDateString() : '-'}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="restoreDepartment(${dept.id})" title="Restore">
                                        <i class="bi bi-arrow-counterclockwise"></i> Restore
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmPermanentDelete(${dept.id})" title="Permanent Delete">
                                        <i class="bi bi-trash-fill"></i> Delete Forever
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load archived departments</td></tr>';
                    }
                }
            };

            window.restoreDepartment = async function (id) {
                try {
                    const response = await API.department.restore(id);
                    if (response.success) {
                        dashboard.showToast('Success', 'Department restored successfully!', 'success');
                        dashboard.loadDeletedDepartments();
                    } else {
                        dashboard.showToast('Error', 'Failed to restore department', 'error');
                    }
                } catch (error) {
                    dashboard.showToast('Error', 'Failed to restore department', 'error');
                }
            };

            window.confirmPermanentDelete = async function (id) {
                try {
                    const checkResponse = await API.department.canPermanentlyDelete(id);
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    const deleteMessage = document.getElementById('deleteMessage');
                    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

                    window.deleteConfirmId = id;

                    if (checkResponse && checkResponse.success && checkResponse.data) {
                        const canDelete = checkResponse.data.canDelete || checkResponse.data.CanDelete;
                        const reason = checkResponse.data.reason || checkResponse.data.Reason || 'Unknown reason';

                        if (canDelete) {
                            deleteMessage.innerHTML = `
                                <div class="text-warning mb-3">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                    <h5>‚ö†Ô∏è PERMANENT DELETE WARNING</h5>
                                </div>
                                <p>This department has no students, instructors, or courses.</p>
                                <p class="text-danger"><strong>This action will permanently remove this department from the database and CANNOT be undone!</strong></p>
                                <p>Are you sure you want to proceed?</p>
                            `;
                            confirmDeleteBtn.style.display = 'inline-block';
                        } else {
                            deleteMessage.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-ban fa-2x mb-3"></i>
                                    <h5>‚ùå Cannot Permanently Delete</h5>
                                </div>
                                <p><strong>Reason:</strong> ${reason}</p>
                                <p>This department must remain in the system to preserve:</p>
                                <ul class="text-start">
                                    <li>Student enrollment records</li>
                                    <li>Instructor assignments</li>
                                    <li>Course offerings</li>
                                    <li>Academic history</li>
                                </ul>
                                <p class="text-info mt-3"><i class="fas fa-info-circle"></i> You can restore this department to make it active again.</p>
                            `;
                            confirmDeleteBtn.style.display = 'none';
                        }
                    } else {
                        deleteMessage.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>Error</h5>
                            </div>
                            <p>Unable to verify department data. Permanent deletion is not available for safety.</p>
                        `;
                        confirmDeleteBtn.style.display = 'none';
                    }

                    deleteModal.show();
                } catch (error) {
                    console.error('Error checking department deletion eligibility:', error);
                }
            };

            await dashboard.loadDeletedDepartments();

            document.getElementById('logoutBtn').addEventListener('click', function (e) {
                e.preventDefault();
                API.logout();
                window.location.href = '../index.html';
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
                const id = window.deleteConfirmId;
                if (!id) return;

                try {
                    const response = await API.department.permanentDelete(id);
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide();

                    if (response.success) {
                        dashboard.showToast('Success', 'Department permanently deleted!', 'success');
                        dashboard.loadDeletedDepartments();
                    } else {
                        dashboard.showToast('Error', 'Failed to delete department', 'error');
                    }
                } catch (error) {
                    dashboard.showToast('Error', 'Failed to delete department', 'error');
                }
            });
        });
    </script>
</body>

</html>