<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Management - Smart Campus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/modern-theme.css">
    <link rel="stylesheet" href="../css/archived-pages.css">
    <style>
        .enrollment-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--sage-100);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .enrollment-card:hover {
            box-shadow: 0 8px 20px rgba(90, 122, 90, 0.12);
            transform: translateY(-3px);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .student-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--sage-400), var(--sage-500));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .course-tag {
            background: var(--cream-200);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--sage-800);
            border: 1px solid var(--sage-200);
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--sage-200);
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--sage-600);
            color: white;
            border-color: var(--sage-600);
        }
    </style>
</head>

<body>
    <!-- Modern Navigation -->
    <nav class="modern-nav">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <a href="#" class="nav-brand">
                    <div class="nav-icon">
                        <i class="bi bi-mortarboard-fill"></i>
                    </div>
                    <span>Smart Campus</span>
                </a>
                <div class="d-flex gap-2">
                    <a href="admin-dashboard.html" class="btn btn-light btn-nav">
                        <i class="bi bi-grid-fill me-2"></i>Dashboard
                    </a>
                    <button id="logoutBtn" class="btn btn-danger btn-nav">
                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-content" style="margin-left: 0; max-width: 1400px; margin: 0 auto; padding: 2rem;">
        <!-- Page Header -->
        <div class="modern-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 800; color: var(--sage-800); margin: 0;">
                        <i class="bi bi-clipboard-check-fill me-3" style="color: var(--sage-600);"></i>
                        Enrollment Management
                    </h1>
                    <p style="color: var(--gray-500); margin: 0.5rem 0 0 0;">Review and manage student enrollment
                        requests</p>
                </div>
                <button onclick="window.history.back()" class="btn-back">
                    <i class="bi bi-arrow-left"></i>
                    <span>Back</span>
                </button>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="stat-card-modern">
                    <div class="stat-icon-modern stat-icon-warning">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="stat-value-modern" id="totalPending">0</div>
                    <div class="stat-label-modern">Pending Review</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card-modern">
                    <div class="stat-icon-modern stat-icon-success">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="stat-value-modern" id="totalApproved">0</div>
                    <div class="stat-label-modern">Approved Today</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card-modern">
                    <div class="stat-icon-modern stat-icon-sage">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-value-modern" id="totalEnrollments">0</div>
                    <div class="stat-label-modern">Total Enrollments</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card-modern">
                    <div class="stat-icon-modern stat-icon-info">
                        <i class="bi bi-book-fill"></i>
                    </div>
                    <div class="stat-value-modern" id="totalCourses">0</div>
                    <div class="stat-label-modern">Active Courses</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="modern-card mb-4">
            <div class="d-flex gap-2 flex-wrap">
                <div class="filter-chip active" onclick="filterEnrollments('all')">
                    <i class="bi bi-grid-3x3-gap-fill me-2"></i>All
                </div>
                <div class="filter-chip" onclick="filterEnrollments('Pending')">
                    <i class="bi bi-hourglass-split me-2"></i>Pending
                </div>
                <div class="filter-chip" onclick="filterEnrollments('Enrolled')">
                    <i class="bi bi-check-circle me-2"></i>Enrolled
                </div>
                <div class="filter-chip" onclick="filterEnrollments('Rejected')">
                    <i class="bi bi-x-circle me-2"></i>Rejected
                </div>
                <div class="filter-chip" onclick="filterEnrollments('Completed')">
                    <i class="bi bi-award me-2"></i>Completed
                </div>
            </div>
        </div>

        <!-- Enrollments List -->
        <div id="enrollmentsList">
            <div class="text-center py-5">
                <div class="spinner-border" style="color: var(--sage-600); width: 3rem; height: 3rem;"></div>
                <p style="color: var(--gray-500); margin-top: 1rem;">Loading enrollments...</p>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--sage-500), var(--sage-600)); border: none;">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="bi bi-check-circle-fill me-2"></i>Approve Enrollment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p style="color: var(--gray-700); margin-bottom: 1rem;">Are you sure you want to approve this
                        enrollment request?</p>
                    <div id="enrollmentDetails"></div>
                </div>
                <div class="modal-footer" style="border: none; background: var(--gray-50);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        style="border-radius: 10px;">Cancel</button>
                    <button type="button" class="btn-sage" id="confirmApproveBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div class="modal fade" id="rejectionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: none;">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="bi bi-x-circle-fill me-2"></i>Reject Enrollment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p style="color: var(--gray-700); margin-bottom: 1rem;">Are you sure you want to reject this
                        enrollment request?</p>
                    <div id="rejectionDetails"></div>
                </div>
                <div class="modal-footer" style="border: none; background: var(--gray-50);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        style="border-radius: 10px;">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn"
                        style="border-radius: 10px;">Reject</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let allEnrollments = [];
        let approvedToday = 0;
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('authToken');
            if (!token || API.isTokenExpired()) {
                window.location.href = '../index.html';
                return;
            }

            await loadEnrollments();

            document.getElementById('logoutBtn').addEventListener('click', () => {
                API.auth.logout();
                window.location.href = '../index.html';
            });
        });

        async function loadEnrollments() {
            try {
                const response = await API.enrollment.getAll();

                if (response.success && response.data) {
                    allEnrollments = Array.isArray(response.data.data) ? response.data.data :
                        Array.isArray(response.data) ? response.data : [];

                    const pending = allEnrollments.filter(e => e.status === 'Pending').length;
                    document.getElementById('totalPending').textContent = pending;
                    document.getElementById('totalApproved').textContent = approvedToday;
                    document.getElementById('totalEnrollments').textContent = allEnrollments.length;

                    // Count unique courses using CourseCode (case-insensitive)
                    const uniqueCourses = [...new Set(allEnrollments.map(e => (e.courseCode || e.CourseCode || '').toLowerCase()))].filter(code => code);
                    document.getElementById('totalCourses').textContent = uniqueCourses.length;

                    renderEnrollments(allEnrollments);
                }
            } catch (error) {
                console.error('Error:', error);
                notifications.error('Error', 'Failed to load enrollments');
            }
        }

        function renderEnrollments(enrollments) {
            const container = document.getElementById('enrollmentsList');

            if (enrollments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: var(--gray-300);"></i>
                        <h5 style="color: var(--gray-500); margin-top: 1rem;">No enrollments found</h5>
                        <p style="color: var(--gray-400);">Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = enrollments.map(enrollment => {
                const statusBadgeClass = {
                    'Pending': 'badge-pending',
                    'Enrolled': 'badge-approved',
                    'Rejected': 'badge-rejected',
                    'Completed': 'badge-sage'
                }[enrollment.status] || 'badge-sage';

                const initials = (enrollment.studentName || 'NA').split(' ').map(n => n[0]).join('').substring(0, 2);
                const enrollDate = (enrollment.enrollmentDate || enrollment.EnrollmentDate || enrollment.enrolledAt)
                    ? new Date(enrollment.enrollmentDate || enrollment.EnrollmentDate || enrollment.enrolledAt).toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric'
                    }) : 'N/A';

                return `
                    <div class="enrollment-card animate-fadeInUp">
                        <div class="row align-items-center g-3">
                            <div class="col-md-4">
                                <div class="student-info">
                                    <div class="student-avatar">${initials}</div>
                                    <div>
                                        <h6 style="margin: 0; font-weight: 700; color: var(--sage-800);">${enrollment.studentName || 'Unknown'}</h6>
                                        <small style="color: var(--gray-500);">Code: ${enrollment.studentCode || '-'}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="course-tag">
                                    <i class="bi bi-book-fill me-2" style="color: var(--sage-600);"></i>
                                    <strong>${enrollment.courseName || 'Unknown Course'}</strong>
                                </div>
                                <small style="color: var(--gray-500); display: block; margin-top: 0.5rem;">
                                    ${enrollment.departmentName || 'Unknown Department'}
                                </small>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge-modern ${statusBadgeClass}">${enrollment.status || 'Unknown'}</span>
                                <small style="display: block; color: var(--gray-500); margin-top: 0.5rem;">
                                    <i class="bi bi-calendar3 me-1"></i>${enrollDate}
                                </small>
                            </div>
                            <div class="col-md-3 text-end">
                                ${enrollment.status === 'Pending' ? `
                                    <div class="d-flex gap-2 justify-content-end">
                                        <button onclick="approveEnrollment(${enrollment.enrollmentId})" 
                                                class="btn btn-success btn-sm" 
                                                style="border-radius: 8px; font-weight: 600; padding: 0.5rem 1rem;">
                                            <i class="bi bi-check-lg me-1"></i>Approve
                                        </button>
                                        <button onclick="rejectEnrollment(${enrollment.enrollmentId})" 
                                                class="btn btn-danger btn-sm" 
                                                style="border-radius: 8px; font-weight: 600; padding: 0.5rem 1rem;">
                                            <i class="bi bi-x-lg me-1"></i>Reject
                                        </button>
                                    </div>
                                ` : `
                                    <span style="color: var(--gray-400); font-size: 0.875rem;">
                                        <i class="bi bi-check-circle-fill me-1" style="color: var(--accent-success);"></i>
                                        ${enrollment.status}
                                    </span>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.filterEnrollments = function (status) {
            currentFilter = status;
            document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
            event.target.closest('.filter-chip').classList.add('active');

            const filtered = status === 'all' ? allEnrollments : allEnrollments.filter(e => e.status === status);
            renderEnrollments(filtered);
        };

        window.approveEnrollment = function (id) {
            const enrollment = allEnrollments.find(e => e.enrollmentId === id);
            const modal = new bootstrap.Modal(document.getElementById('approvalModal'));

            document.getElementById('enrollmentDetails').innerHTML = `
                <div style="background: var(--cream-100); padding: 1rem; border-radius: 12px; border: 1px solid var(--sage-200);">
                    <p style="margin: 0.5rem 0;"><strong>Student:</strong> ${enrollment.studentName}</p>
                    <p style="margin: 0.5rem 0;"><strong>Course:</strong> ${enrollment.courseName}</p>
                </div>
            `;

            window.currentEnrollmentId = id;
            modal.show();
        };

        window.rejectEnrollment = function (id) {
            const enrollment = allEnrollments.find(e => e.enrollmentId === id);
            const modal = new bootstrap.Modal(document.getElementById('rejectionModal'));

            document.getElementById('rejectionDetails').innerHTML = `
                <div style="background: #fee2e2; padding: 1rem; border-radius: 12px; border: 1px solid #fca5a5;">
                    <p style="margin: 0.5rem 0;"><strong>Student:</strong> ${enrollment.studentName}</p>
                    <p style="margin: 0.5rem 0;"><strong>Course:</strong> ${enrollment.courseName}</p>
                </div>
            `;

            window.currentEnrollmentId = id;
            modal.show();
        };

        document.getElementById('confirmApproveBtn').addEventListener('click', async function () {
            try {
                const response = await API.enrollment.approve(window.currentEnrollmentId);
                bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();

                if (response.success) {
                    notifications.success('Success', 'Enrollment approved successfully!');
                    approvedToday++;
                    await loadEnrollments();
                } else {
                    notifications.error('Error', response.error || 'Failed to approve enrollment');
                }
            } catch (error) {
                notifications.error('Error', 'Failed to approve enrollment');
            }
        });

        document.getElementById('confirmRejectBtn').addEventListener('click', async function () {
            try {
                const response = await API.enrollment.reject(window.currentEnrollmentId);
                bootstrap.Modal.getInstance(document.getElementById('rejectionModal')).hide();

                if (response.success) {
                    notifications.success('Success', 'Enrollment rejected');
                    await loadEnrollments();
                } else {
                    notifications.error('Error', response.error || 'Failed to reject enrollment');
                }
            } catch (error) {
                notifications.error('Error', 'Failed to reject enrollment');
            }
        });
    </script>
</body>

</html>